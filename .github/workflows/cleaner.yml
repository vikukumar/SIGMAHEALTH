name: Daily Cache Cleanup

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at 00:00 UTC
  workflow_dispatch:

permissions:
  actions: write  # Required to delete caches
  contents: read

jobs:
  clear-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Set up GitHub CLI
        uses: cli/cli-action@v2
        with:
          version: latest

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Delete all caches with prefix
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PREFIX: trigger-cache-
        run: |
          echo "Fetching cache list..."
          caches=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/$OWNER/$REPO/actions/caches | jq -c '.actions_caches[]')

          deleted=0
          echo "$caches" | while read -r cache; do
            key=$(echo "$cache" | jq -r '.key')
            id=$(echo "$cache" | jq -r '.id')
            if [[ "$key" == $PREFIX* ]]; then
              echo "Deleting cache: $key (ID: $id)"
              gh api --method DELETE /repos/$OWNER/$REPO/actions/caches/$id
              ((deleted++))
            fi
          done

          echo "âœ… Deleted $deleted cache(s) with prefix '$PREFIX'"
