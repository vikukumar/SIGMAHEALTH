name: Daily Cache Cleanup

on:
  schedule:
    - cron: '0 0 * * *'  # Every day at 00:00 UTC
  workflow_dispatch:

permissions:
  actions: write  # Required to delete caches
  contents: read

jobs:
  clear-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI (from official .deb)
        run: |
          curl -fsSL -o gh.deb https://github.com/cli/cli/releases/latest/download/gh_2.49.0_linux_amd64.deb
          sudo dpkg -i gh.deb
          gh --version

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Delete all caches with prefix
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PREFIX: trigger-cache-
        run: |
          echo "Fetching caches for $OWNER/$REPO..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/$OWNER/$REPO/actions/caches | \
            jq -c '.actions_caches[]' | while read -r cache; do
              key=$(echo "$cache" | jq -r '.key')
              id=$(echo "$cache" | jq -r '.id')
              if [[ "$key" == $PREFIX* ]]; then
                echo "Deleting cache: $key (ID: $id)"
                gh api --method DELETE /repos/$OWNER/$REPO/actions/caches/$id
              fi
            done
